<!DOCTYPE>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>文本编辑器</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script type="text/javascript" charset="utf-8" th:src="@{ueditor.config.js}"></script>
    <script type="text/javascript" charset="utf-8" th:src="@{ueditor.all.js}"></script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" th:src="@{lang/zh-cn/zh-cn.js}"></script>
    <script type="text/javascript" th:src="@{js/jquery-3.3.1.min.js}"></script>
    <style type="text/css">
        div {
            width: 100%;
        }
    </style>

</head>

<body>
    <form action="" method="post" id="article-form" enctype="multipart/form-data">
        文章标题：<input type="text" name="articleName" id="article_title">
        文章类别选择：
        <span id="articleCategorySelect"></span>
        文章作者选择：
        <span id="articleEditorSelect"></span>
        文章标签选择：
        <span id="articleLabelSelect1"></span><span id="articleLabelSelect2"></span>
        是否推荐：
        <select id="recommend">
            <option value="1">是</option>
            <option value="0">否</option>
        </select>

        </br>
        <input type="hidden" name="articleText">
        封面图片：<input type="file" onchange="changImg(event)" name="articleImgSrc" id="article_Img">
        图片alt属性<input type="text" id="img_alt"><br>

            <img id="imghead" border="0" src="img/photo_icon.png" height="100px",width="100px">
        </br>
        meta标签title：<input type="text" id="article_meta_title">
        meta标签description：<input type="text" id="article_meta_description">
        meta标签keyword：<input type="text" id="article_meta_keyword">
    </form>
    <!--图片回显js-->
    <script type="text/javascript">
        function changImg(e){
            for (var i = 0; i < e.target.files.length; i++) {
                var file = e.target.files.item(i);
                if (!(/^image\/.*$/i.test(file.type))) {
                    continue; //不是图片 就跳出这一次循环
                }
                //实例化FileReader API
                var freader = new FileReader();
                freader.readAsDataURL(file);
                freader.onload = function(e) {
                    $("#imghead").attr("src",e.target.result);
                }
            }
        }
    </script>
    <script id="editor" type="text/plain" style="width:1024px;height:500px;"></script>
</div>
<div id="btns">
    <div>
        <button onclick="articleAdd()">确认提交</button>

    </div>

</div>
<div>

</div>


<script type="text/javascript">

    //实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor');
    /*获得编辑器的内容*/
    function getContent() {
    var text = [];
    /* arr.push("使用editor.getContent()方法可以获得编辑器的内容");*/
    text.push(UE.getEditor('editor').getContent());
     return text;
    }

  /*  function setContent(isAppendTo) {
if (text_value){
            var arr = [];
            arr.push("使用editor.setContent('欢迎使用ueditor')方法可以设置编辑器的内容");
            UE.getEditor('editor').setContent(text_value, isAppendTo);
}
    }*/



    /* 判断编辑器里是否有内容*/
    function hasContent() {
    var arr = [];
    arr.push("使用editor.hasContents()方法判断编辑器里是否有内容");
    arr.push("判断结果为：");
    arr.push(UE.getEditor('editor').hasContents());
    alert(arr.join("\n"));
    }

    /* 根据文章id编辑文章*/
    function updateArticle() {
    $.ajax({
    url:'http://localhost:9999/visney-manager/article/getArticleDetails/'+id,
    type:"get",
    async: false,
    success:function(data){
    if(data!=null){
    console.log(data)
    UE.getEditor('editor').addListener("ready", function () {
    // editor准备好之后才可以使用
    UE.getEditor('editor').setContent(data.articleText);


    });


    }
    },
    error:function (data) {
    alert("添加失败")
    }
    });
    }

    // 图片回显
    //添加图片回显
    function previewImage(file) {
    var MAXWIDTH = 90;
    var MAXHEIGHT = 90;
    var div = document.getElementById('preview');
    if (file.files && file.files[0]) {
    div.innerHTML = '<img id=imghead onclick=$("#previewImg").click()>';
    var img = document.getElementById('imghead');
    img.onload = function () {
    var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
    img.width = rect.width;
    img.height = rect.height;
    img.style.marginTop = rect.top + 'px';
    }
    var reader = new FileReader();
    reader.onload = function (evt) {
    img.src = evt.target.result;
    }
    reader.readAsDataURL(file.files[0]);
    }

    }


</script>
    <script type="text/javascript">



            //截取url后的参数
            function GetRequest() {
                var url = location.search; //获取url中"?"符后的字串
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                    strs = str.split("&");
                    for(var i = 0; i < strs.length; i ++) {
                        theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
                    }
                }
                return theRequest;
            }

            //获取修改文章的id
            var Request = new Object();
            Request = GetRequest();
            var id=Request["id"]

            if (id) {
                alert(id)
                var id_value;
                var title_value;
                var category_id;
                var editor_id;
                var label_value1;
                var label_value2;
                var label_id1;
                var label_id2;
                var recommend_value;
                var img_id;
                var img_src_value;
                var img_alt_value;
                var text_value;
                var meta_titile_value;
                var meta_description_value;
                var meta_keyword_value;
                $.ajax({
                    type: 'get',
                    async: false,/*设置为同步，不出结果的话，不往下执行*/
                    url: 'http://localhost:9999/visney-manager/article/getArticleDetails/'+id,
                    success: function (value) {
                        title_value=value.articleName;
                        category_id=value.articleCategory.articleCategoryId;
                        editor_id=value.articleEditor.articleEditorId;
                        label_value1=value.labelList[0].articleLabelName;
                        label_value2=value.labelList[1].articleLabelName;
                        /*有问题需要修改*/
                        label_id1=value.labelList[0].articleLabelId;
                        label_id2=value.labelList[1].articleLabelId;

                        recommend_value=value.articleRecommend;
                        img_id=value.articleImg.articleImgId;
                        img_src_value=value.articleImg.articleImgSrc;
                        img_alt_value=value.articleImg.articleImgAlt;
                        text_value=value.articleText;
                        meta_titile_value=value.articleName;
                        meta_description_value=value.articleName;
                        meta_keyword_value=value.articleName;

                        $("#recommend").find("option[value = '"+recommend_value+"']").attr("selected","selected");
                        $("#img_alt").val(img_alt_value);
                        $("#imghead").prop("src",img_src_value);
                        $("#article_meta_title").val(meta_titile_value);
                        $("#article_meta_description").val(meta_description_value);
                        $("#article_meta_keyword").val(meta_keyword_value);
                        $("#article_title").val(title_value);

                        /* 查询结束后，再去查询其他的内容*/
                        show();

                    }
                })
                ue.addListener("ready", function () {
                    ue.setContent(text_value);
                });

            }else { show();}




            function show(){
                /* 展示可供选择的文章类别*/
                $.ajax({
                    type: 'get',
                    url: 'http://localhost:9999/visney-manager/articleCategory/getAll',
                    success: function (value) {
                        var content = "<select id=\"category_select\">"
                        for (var i = 0; i < value.length; i++) {
                            content += "<option value=" + value[i].articleCategoryId + ">" + value[i].articleCategoryName + "</option>";
                        }
                        var result = content + "</select>";

                        $("#articleCategorySelect").html(result)


                        $("#category_select").find("option[value = '"+category_id+"']").attr("selected","selected");
                    }
                })

                /*展示作者*/
                $.ajax({
                    type: 'post',
                    url: 'http://localhost:9999/visney-manager/articleEditor/getAllArticleEditor',
                    data:{
                        page:0,
                        rows:0

                    },
                    success: function (value) {

                        var content = "<select id=\"editor_select\">"
                        for (var i = 0; i < value.rows.length; i++) {
                            content += "<option value=" + value.rows[i].articleEditorId + ">" + value.rows[i].articleEditorName + "</option>";
                        }
                        var result = content + "</select>";

                        $("#articleEditorSelect").html(result)
                        $("#editor_select").find("option[value = '"+editor_id+"']").attr("selected","selected");

                    }
                })
                /*展示标签*/
                $.ajax({
                    type: 'post',
                    url: 'http://localhost:9999/visney-manager/articleLabel/getAllArticleLabel',
                    data:{
                        page:0,
                        rows:0

                    },
                    success: function (value) {
                        var content1 = "<select id=\"label_select1\">"
                        var content2 = "<select id=\"label_select2\">"
                        for (var i = 0; i < value.rows.length; i++) {
                            content1 += "<option value=" + value.rows[i].articleLabelId +' '+'text='+'"'+value.rows[i].articleLabelName +'"'+">" + value.rows[i].articleLabelName + "</option>";
                        }
                        for (var i = 0; i < value.rows.length; i++) {
                            content2 += "<option value=" + value.rows[i].articleLabelId +' '+'text='+'"'+value.rows[i].articleLabelName +'"'+">" + value.rows[i].articleLabelName + "</option>";
                        }

                        var result1 = content1 + "</select>";
                        var result2 = content2 + "</select>";

                        $("#articleLabelSelect1").html(result1)
                        $("#articleLabelSelect2").html(result2)


                        $("#label_select1").find("option[text ='"+label_value1+"']").attr("selected","selected");
                        $("#label_select2").find("option[text ='"+label_value2+"']").attr("selected","selected");



                    }
                })

            }
           /* 文章添加,和修改共用*/
            function articleAdd() {
                //选中的文本
                var articleTitle = $("#article_title").val();
                var cid=$('#category_select option:selected').val();
                var eid=$('#editor_select option:selected').val();

                var lname1=$('#label_select1 option:selected').text();
                var lname2=$('#label_select2 option:selected').text();
                var lid1=$('#label_select2 option:selected').val();
                var lid2=$('#label_select2 option:selected').val();

                var article_recommend=$("#recommend option:selected").val();

                var meta_title= $("#article_meta_title").val();
                var meta_description=$("#article_meta_description").val();
                var meta_keyword=$("#article_meta_keyword").val();

                var articletext=getContent();

                var articleimg=document.getElementById("article_Img").files[0];

                var imgalt = $("#img_alt").val();

                var formdata=new FormData();
                /*选中的标签名称*/
                formdata.append("label1",lname1);
                formdata.append("label2",lname2);
                formdata.append("articleName",articleTitle);
                formdata.append("articleText",articletext);
                formdata.append("articleEditor.articleEditorId",eid);
                formdata.append("articleCategory.articleCategoryId",cid);
                formdata.append(" articleRecommend",article_recommend);
                formdata.append("articleMetaDescription",meta_description);
                formdata.append("articleMetaTitle",meta_title);
                formdata.append("articleKeyWord",meta_keyword);
                formdata.append("articleImg.articleImgAlt",imgalt);
                formdata.append("files",articleimg);
                if (id){
                    /*修改*/
                    formdata.append("articleId",id);
                  /*  原文章标签对应的id，需要这两个id进行修改标签的名字*/
                    formdata.append("labelID1",label_id1);
                    formdata.append("labelID2",label_id2);
                    formdata.append("articleImg.articleImgId",img_id);
                    formdata.append("articleImg.articleImgSrc",img_src_value);
                    $.ajax({
                        type: 'post',
                        url: 'http://localhost:9999/visney-manager/article/articleUpdate',
                        data: formdata,
                        async: false,/*设置为同步，不出结果的话，不往下执行*/

                        processData: false,// 告诉jQuery不要去处理发送的数据
                        contentType: false,// 告诉jQuery不要去设置Content-Type请求头
                        success: function (data) {
                            if (data==1){
                                alert("修改成功")
                            }
                            else{
                                alert("修改失败")
                            }

                        }
                    })

                }

if (!id) {
                /*添加*/
                $.ajax({
                    type: 'post',
                    url: 'http://localhost:9999/visney-manager/article/articleAdd',
                    data: formdata,
                    processData: false,// 告诉jQuery不要去处理发送的数据
                    contentType: false,// 告诉jQuery不要去设置Content-Type请求头
                    success: function (data) {
                        if (data==1){
                            alert("添加成功")
                        }
                        else{
                            alert("添加失败")
                        }

                    }
                })

}

            }

            /* 根据文章id编辑文章*/
            /*  function updateArticle() {
                  $.ajax({
                      url:'http://localhost:9999/visney-manager/article/getArticleDetails/'+id,
                      type:"get",
                      dataType:"json",
                      async: false,
                      success:function(data){
                          if(data!=null){
                              console.log(data)
                              UE.getEditor('editor').addListener("ready", function () {
                                  // editor准备好之后才可以使用
                                  UE.getEditor('editor').setContent(data.articleText);
                                  /!* setContent(data.text)*!/

                              });


                          }
                      },
                      error:function (data) {
                          alert("添加失败")
                      }
                  });
              }*/

    </script>
</body>
</html>

